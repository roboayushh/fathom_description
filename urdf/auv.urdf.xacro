<?xml version="1.0"?>
<robot name="rexrov">

  <!-- Base Link -->
  <link name="base_link">
    <inertial>
      <origin xyz="0 0 -0.59" rpy="0 0 0"/>
      <mass>1862.87</mass>
      <inertia>
        <ixx>525.39</ixx>
        <ixy>1.44</ixy>
        <ixz>33.41</ixz>
        <iyy>794.20</iyy>
        <iyz>2.6</iyz>
        <izz>691.23</izz>
      </inertia>
    </inertial>

    <visual>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <mesh>
          <scale>1 1 1</scale>
          <uri>model://meshes/rexrov/RexROV_no_props.dae</uri>
        </mesh>
      </geometry>
    </visual>

    <!-- Bottom plate collision -->
    <collision>
      <origin xyz="0 0 -0.75" rpy="0 0 0"/>
      <geometry>
        <box>
          <size>2.56 1.50 0.10</size>
        </box>
      </geometry>
    </collision>

    <!-- Top plate collision -->
    <collision>
      <origin xyz="0 0 0.60" rpy="0 0 0"/>
      <geometry>
        <box>
          <size>2.56 1.50 0.40</size>
        </box>
      </geometry>
    </collision>

    <!-- Left side collision -->
    <collision>
      <origin xyz="-0.20 0.70 -0.15" rpy="0 0 0"/>
      <geometry>
        <box>
          <size>2.20 0.10 1.10</size>
        </box>
      </geometry>
    </collision>

    <!-- Right side collision -->
    <collision>
      <origin xyz="0.20 -0.70 -0.15" rpy="0 0 0"/>
      <geometry>
        <box>
          <size>2.20 0.10 1.10</size>
        </box>
      </geometry>
    </collision>
  </link>

  <!-- Camera Link -->
  <link name="camera_link">
    <inertial>
      <mass>0.1</mass>
      <inertia>
        <ixx>0.000166667</ixx>
        <ixy>0</ixy>
        <ixz>0</ixz>
        <iyy>0.000166667</iyy>
        <iyz>0</iyz>
        <izz>0.000166667</izz>
      </inertia>
    </inertial>
    <collision>
      <geometry>
        <box>
          <size>0.1 0.1 0.1</size>
        </box>
      </geometry>
    </collision>
    <visual>
      <geometry>
        <box>
          <size>0.1 0.1 0.1</size>
        </box>
      </geometry>
    </visual>
  </link>

  <joint name="camera_joint" type="fixed">
    <origin xyz="1.33 0 -0.74" rpy="0 0 0"/>
    <parent>base_link</parent>
    <child>camera_link</child>
  </joint>

  <gazebo reference="camera_link">
    <sensor name="underwater_camera" type="rgbd_camera">
      <update_rate>10</update_rate>
      <visualize>true</visualize>
      <always_on>1</always_on>
      <topic>/model/rexrov/camera</topic>
      <camera>
        <horizontal_fov>1.05</horizontal_fov>
        <image>
          <width>1920</width>
          <height>1080</height>
        </image>
        <clip>
          <near>0.1</near>
          <far>10.0</far>
        </clip>
      </camera>
      <!-- <plugin filename="UnderwaterCamera" name="dave_gz_sensor_plugins::UnderwaterCamera">
        <attenuationR>0.8</attenuationR>
        <attenuationG>0.5</attenuationG>
        <attenuationB>0.2</attenuationB>
        <backgroundR>85</backgroundR>
        <backgroundG>107</backgroundG>
        <backgroundB>47</backgroundB>
      </plugin> -->
    </sensor>
  </gazebo>

  <!-- Magnetometer Link -->
  <link name="magnetometer_link">
    <inertial>
      <mass>0.015</mass>
      <inertia>
        <ixx>0.00001</ixx>
        <ixy>0.0</ixy>
        <ixz>0.0</ixz>
        <iyy>0.00001</iyy>
        <iyz>0.0</iyz>
        <izz>0.00001</izz>
      </inertia>
    </inertial>
  </link>

  <joint name="magnetometer_joint" type="fixed">
    <origin xyz="0 0 0" rpy="0 0 0"/>
    <parent>base_link</parent>
    <child>magnetometer_link</child>
  </joint>

  <gazebo reference="magnetometer_link">
    <sensor name="magnetometer_sensor" type="magnetometer">
      <always_on>true</always_on>
      <update_rate>50.0</update_rate>
      <topic>/model/rexrov/magnetometer</topic>
      <magnetometer>
        <x>
          <noise type="gaussian">
            <mean>0.0</mean>
            <stddev>1.0</stddev>
          </noise>
        </x>
        <y>
          <noise type="gaussian">
            <mean>0.0</mean>
            <stddev>1.0</stddev>
          </noise>
        </y>
        <z>
          <noise type="gaussian">
            <mean>0.0</mean>
            <stddev>1.4</stddev>
          </noise>
        </z>
      </magnetometer>
    </sensor>
  </gazebo>

  <!-- IMU Link -->
  <link name="imu_link">
    <inertial>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <mass>0.015</mass>
      <inertia>
        <ixx>0.00001</ixx>
        <ixy>0.0</ixy>
        <ixz>0.0</ixz>
        <iyy>0.00001</iyy>
        <iyz>0.0</iyz>
        <izz>0.00001</izz>
      </inertia>
    </inertial>
  </link>

  <joint name="imu_joint" type="fixed">
    <origin xyz="0 0 0" rpy="0 0 0"/>
    <parent>base_link</parent>
    <child>imu_link</child>
  </joint>

  <gazebo reference="imu_link">
    <sensor name="imu_sensor" type="imu">
      <always_on>true</always_on>
      <update_rate>50.0</update_rate>
      <topic>/model/rexrov/imu</topic>
    </sensor>
  </gazebo>

  <!-- DVL Link -->
  <link name="dvl_link">
    <inertial>
      <mass>3.5</mass>
      <inertia>
        <ixx>0.0195872</ixx>
        <ixy>0</ixy>
        <ixz>0</ixz>
        <iyy>0.0195872</iyy>
        <iyz>0</iyz>
        <izz>0.0151357</izz>
      </inertia>
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 3.14159"/>
      <geometry>
        <mesh>
          <scale>1 1 1</scale>
          <uri>model://meshes/nortek_dvl500_300/DVL500-300m.dae</uri>
        </mesh>
      </geometry>
      <cast_shadows>1</cast_shadows>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="3.14159 0 0"/>
      <geometry>
        <cylinder>
          <radius>0.093</radius>
          <length>0.203</length>
        </cylinder>
      </geometry>
    </collision>
  </link>

  <joint name="dvl_joint" type="fixed">
    <origin xyz="-1.34 0 -0.75" rpy="0 0 -1.57"/>
    <parent>base_link</parent>
    <child>dvl_link</child>
  </joint>

  <gazebo reference="dvl_link">
    <sensor name="nortek_dvl500_300" type="custom" gz:type="dvl">
      <pose>0 0 0 0 0 0</pose>
      <always_on>1</always_on>
      <update_rate>8</update_rate>
      <topic>/model/rexrov/dvl/velocity</topic>
      <gz:dvl>
        <type>phased_array</type>
        <arrangement degrees="true">
          <beam id="1">
            <aperture>3</aperture>
            <rotation>-135</rotation>
            <tilt>25</tilt>
          </beam>
          <beam>
            <aperture>3</aperture>
            <rotation>135</rotation>
            <tilt>25</tilt>
          </beam>
          <beam>
            <aperture>3</aperture>
            <rotation>45</rotation>
            <tilt>25</tilt>
          </beam>
          <beam>
            <aperture>3</aperture>
            <rotation>-45</rotation>
            <tilt>25</tilt>
          </beam>
        </arrangement>
        <tracking>
          <water_mass_mode>
            <when>best</when>
            <water_velocity>
              <x>0.</x>
              <y>0.</y>
              <z>0.</z>
            </water_velocity>
            <boundaries>
              <near>10.</near>
              <far>100.</far>
            </boundaries>
            <bins>10</bins>
            <noise type="gaussian">
              <stddev>0.015</stddev>
            </noise>
            <visualize>true</visualize>
          </water_mass_mode>
          <bottom_mode>
            <when>best</when>
            <noise type="gaussian">
              <stddev>0.005</stddev>
            </noise>
            <visualize>true</visualize>
          </bottom_mode>
        </tracking>
        <maximum_range>200.</maximum_range>
        <minimum_range>0.3</minimum_range>
        <!-- ENU to FSD -->
        <reference_frame>0 0 0 3.14 0 -1.57</reference_frame>
      </gz:dvl>
    </sensor>
  </gazebo>

  <!-- Thruster Links -->
  <link name="thruster1">
    <inertial>
      <mass>0.001</mass>
      <inertia>
        <ixx>0.0005</ixx>
        <ixy>0</ixy>
        <ixz>0</ixz>
        <iyy>0.0005</iyy>
        <iyz>0</iyz>
        <izz>0.0005</izz>
      </inertia>
    </inertial>
    <visual>
      <geometry>
        <mesh>
          <scale>1 1 1</scale>
          <uri>model://meshes/rexrov/prop.dae</uri>
        </mesh>
      </geometry>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder>
          <length>0.000001</length>
          <radius>0.000001</radius>
        </cylinder>
      </geometry>
    </collision>
  </link>

  <joint name="thruster1_joint" type="continuous">
    <origin xyz="-0.890895 0.334385 0.528822" rpy="0 -1.300794 -0.928689"/>
    <parent>base_link</parent>
    <child>thruster1</child>
    <axis>
      <xyz>1 0 0</xyz>
    </axis>
  </joint>

  <!-- Repeat for other thrusters similarly -->
  <link name="thruster2">
    <inertial>
      <mass>0.001</mass>
      <inertia>
        <ixx>0.0005</ixx>
        <ixy>0</ixy>
        <ixz>0</ixz>
        <iyy>0.0005</iyy>
        <iyz>0</iyz>
        <izz>0.0005</izz>
      </inertia>
    </inertial>
    <visual>
      <geometry>
        <mesh>
          <scale>1 1 1</scale>
          <uri>model://meshes/rexrov/prop.dae</uri>
        </mesh>
      </geometry>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder>
          <length>0.000001</length>
          <radius>0.000001</radius>
        </cylinder>
      </geometry>
    </collision>
  </link>

  <joint name="thruster2_joint" type="continuous">
    <origin xyz="-0.890895 -0.334385 0.528822" rpy="0 -1.300794 0.928689"/>
    <parent>base_link</parent>
    <child>thruster2</child>
    <axis>
      <xyz>1 0 0</xyz>
    </axis>
  </joint>

  <link name="thruster3">
    <inertial>
      <mass>0.001</mass>
      <inertia>
        <ixx>0.0005</ixx>
        <ixy>0</ixy>
        <ixz>0</ixz>
        <iyy>0.0005</iyy>
        <iyz>0</iyz>
        <izz>0.0005</izz>
      </inertia>
    </inertial>
    <visual>
      <geometry>
        <mesh>
          <scale>1 1 1</scale>
          <uri>model://meshes/rexrov/prop.dae</uri>
        </mesh>
      </geometry>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder>
          <length>0.000001</length>
          <radius>0.000001</radius>
        </cylinder>
      </geometry>
    </collision>
  </link>

  <joint name="thruster3_joint" type="continuous">
    <origin xyz="0.890895 0.334385 0.528822" rpy="0 -1.840798 0.928689"/>
    <parent>base_link</parent>
    <child>thruster3</child>
    <axis>
      <xyz>1 0 0</xyz>
    </axis>
  </joint>

  <link name="thruster4">
    <inertial>
      <mass>0.001</mass>
      <inertia>
        <ixx>0.0005</ixx>
        <ixy>0</ixy>
        <ixz>0</ixz>
        <iyy>0.0005</iyy>
        <iyz>0</iyz>
        <izz>0.0005</izz>
      </inertia>
    </inertial>
    <visual>
      <geometry>
        <mesh>
          <scale>1 1 1</scale>
          <uri>model://meshes/rexrov/prop.dae</uri>
        </mesh>
      </geometry>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder>
          <length>0.000001</length>
          <radius>0.000001</radius>
        </cylinder>
      </geometry>
    </collision>
  </link>

  <joint name="thruster4_joint" type="continuous">
    <origin xyz="0.890895 -0.334385 0.528822" rpy="0 -1.300794 -0.928689"/>
    <parent>base_link</parent>
    <child>thruster4</child>
    <axis>
      <xyz>1 0 0</xyz>
    </axis>
  </joint>

  <link name="thruster5">
    <inertial>
      <mass>0.001</mass>
      <inertia>
        <ixx>0.0005</ixx>
        <ixy>0</ixy>
        <ixz>0</ixz>
        <iyy>0.0005</iyy>
        <iyz>0</iyz>
        <izz>0.0005</izz>
      </inertia>
    </inertial>
    <visual>
      <geometry>
        <mesh>
          <scale>1 1 1</scale>
          <uri>model://meshes/rexrov/prop.dae</uri>
        </mesh>
      </geometry>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder>
          <length>0.000001</length>
          <radius>0.000001</radius>
        </cylinder>
      </geometry>
    </collision>
  </link>

  <joint name="thruster5_joint" type="continuous">
    <origin xyz="-0.412125 0.505415 0.129" rpy="0 0 0.785398"/>
    <parent>base_link</parent>
    <child>thruster5</child>
    <axis>
      <xyz>1 0 0</xyz>
    </axis>
  </joint>

  <link name="thruster6">
    <inertial>
      <mass>0.001</mass>
      <inertia>
        <ixx>0.0005</ixx>
        <ixy>0</ixy>
        <ixz>0</ixz>
        <iyy>0.0005</iyy>
        <iyz>0</iyz>
        <izz>0.0005</izz>
      </inertia>
    </inertial>
    <visual>
      <geometry>
        <mesh>
          <scale>1 1 1</scale>
          <uri>model://meshes/rexrov/prop.dae</uri>
        </mesh>
      </geometry>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder>
          <length>0.000001</length>
          <radius>0.000001</radius>
        </cylinder>
      </geometry>
    </collision>
  </link>

  <joint name="thruster6_joint" type="continuous">
    <origin xyz="-0.412125 -0.505415 0.129" rpy="0 0 -0.785398"/>
    <parent>base_link</parent>
    <child>thruster6</child>
    <axis>
      <xyz>1 0 0</xyz>
    </axis>
  </joint>

  <link name="thruster7">
    <inertial>
      <mass>0.001</mass>
      <inertia>
        <ixx>0.0005</ixx>
        <ixy>0</ixy>
        <ixz>0</ixz>
        <iyy>0.0005</iyy>
        <iyz>0</iyz>
        <izz>0.0005</izz>
      </inertia>
    </inertial>
    <visual>
      <geometry>
        <mesh>
          <scale>1 1 1</scale>
          <uri>model://meshes/rexrov/prop.dae</uri>
        </mesh>
      </geometry>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder>
          <length>0.000001</length>
          <radius>0.000001</radius>
        </cylinder>
      </geometry>
    </collision>
  </link>

  <joint name="thruster7_joint" type="continuous">
    <origin xyz="0.412125 0.505415 0.129" rpy="0 0 2.356194"/>
    <parent>base_link</parent>
    <child>thruster7</child>
    <axis>
      <xyz>1 0 0</xyz>
    </axis>
  </joint>

  <link name="thruster8">
    <inertial>
      <mass>0.001</mass>
      <inertia>
        <ixx>0.0005</ixx>
        <ixy>0</ixy>
        <ixz>0</ixz>
        <iyy>0.0005</iyy>
        <iyz>0</iyz>
        <izz>0.0005</izz>
      </inertia>
    </inertial>
    <visual>
      <geometry>
        <mesh>
          <scale>1 1 1</scale>
          <uri>model://meshes/rexrov/prop.dae</uri>
        </mesh>
      </geometry>
    </visual>
    <collision>
      <origin xyz="0 0 0" rpy="0 0 0"/>
      <geometry>
        <cylinder>
          <length>0.000001</length>
          <radius>0.000001</radius>
        </cylinder>
      </geometry>
    </collision>
  </link>

  <joint name="thruster8_joint" type="continuous">
    <origin xyz="0.412125 -0.505415 0.129" rpy="0 0 -2.356194"/>
    <parent>base_link</parent>
    <child>thruster8</child>
    <axis>
      <xyz>1 0 0</xyz>
    </axis>
  </joint>


  <!-- Model-level Plugins -->
  <xacro:macro name="thruster_plugin_macro" params="">
    <gazebo>
      <plugin filename="gz-sim-thruster-system" name="gz::sim::systems::Thruster">
        <namespace>rexros</namespace>
        <joint_name>${joint}</joint_name>
        <fluid_density>1000.0</fluid_density>
        <thrust_coefficient>0.00031</thrust_coefficient>
        <velocity_control>true</velocity_control>
        <use_angvel_cmd>false</use_angvel_cmd>
      </plugin>
    </gazebo>
  </xacro:macro>
  <xacro:thruster_plugin_macro joint="thruster1_joint"/>
  <xacro:thruster_plugin_macro joint="thruster2_joint"/>
  <xacro:thruster_plugin_macro joint="thruster3_joint"/>
  <xacro:thruster_plugin_macro joint="thruster4_joint"/>
  <xacro:thruster_plugin_macro joint="thruster5_joint"/>
  <xacro:thruster_plugin_macro joint="thruster6_joint"/>
  <xacro:thruster_plugin_macro joint="thruster7_joint"/>
  <xacro:thruster_plugin_macro joint="thruster8_joint"/>


  <gazebo>
    <plugin filename="gz-sim-hydrodynamics-system" name="gz::sim::systems::Hydrodynamics">
      <disable_coriolis>false</disable_coriolis>
      <disable_added_mass>false</disable_added_mass>
      <water_density>1028</water_density>
      <link_name>base_link</link_name>
      <!-- Added mass -->
      <xDotU>-4.876161</xDotU>
      <yDotV>-126.324739</yDotV>
      <zDotW>-126.324739</zDotW>
      <kDotP>0</kDotP>
      <mDotQ>-33.46</mDotQ>
      <nDotR>-33.46</nDotR>
      <!-- Linear Drag Coefficients -->
      <xU>-74.82</xU>
      <yV>-69.48</yV>
      <zW>-728.4</zW>
      <kP>-268.8</kP>
      <mQ>-309.77</mQ>
      <nR>-105</nR>
      <!-- Quadratic Drag Coefficients -->
      <xUabsU>-748.22</xUabsU>
      <yVabsV>-992.53</yVabsV>
      <zWabsW>-1821.01</zWabsW>
      <kPabsP>-672</kPabsP>
      <mQabsQ>-774.44</mQabsQ>
      <nRabsR>-523.27</nRabsR>
    </plugin>

    <plugin filename="gz-sim-imu-system" name="gz::sim::systems::Imu">
    </plugin>

    <plugin filename="gz-sim-magnetometer-system" name="gz::sim::systems::Magnetometer">
    </plugin>

    <plugin filename="gz-sim-odometry-publisher-system" name="gz::sim::systems::OdometryPublisher">
      <odom_frame>map</odom_frame>
      <robot_base_frame>base_link</robot_base_frame>
      <dimensions>3</dimensions>
      <odom_publish_frequency>100</odom_publish_frequency>
    </plugin>

    <plugin filename="gz-sim-joint-state-publisher-system" name="gz::sim::systems::JointStatePublisher">
    </plugin>
<!-- 
    <plugin filename="DVLBridge" name="dave_ros_gz_plugins::DVLBridge">
      <topic>/model/rexrov/dvl/velocity</topic>
    </plugin> -->

    <!-- <plugin filename="sea_pressure_sensor" name="dave_gz_sensor_plugins::SubseaPressureSensorPlugin">
      <namespace>rexrov</namespace>
      <topic>sea_pressure</topic>
      <update_rate>10</update_rate>
      <noise_sigma>3.0</noise_sigma>
      <estimate_depth_on>true</estimate_depth_on>
      <standard_pressure>101.325</standard_pressure>
      <kPa_per_meter>9.80638</kPa_per_meter>
    </plugin> -->
  </gazebo>

</robot>
